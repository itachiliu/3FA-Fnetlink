<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <title>SD-WAN|SD-Branch|SASE|äº‘ç½‘èåˆ|ä¼ä¸šç»„ç½‘|ç½‘ç»œä¸“çº¿-å…‰è”ä¸–çºª</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1" />
    <meta name="keywords" content="ä¼ä¸šç»„ç½‘,SD-WAN,SD-Branch,sase,mpls,ipsec,ssl,mstp" />
    <meta name="description" content="å…‰è”ä¸–çºª - ä¼ä¸šæ™ºèƒ½ç½‘ç»œæœåŠ¡æä¾›å•†" />

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            color: #333;
            line-height: 1.6;
            background-color: #f8f9fa;
        }

        /* å¤´éƒ¨å¯¼èˆª */
        header {
            background: linear-gradient(135deg, #003366 0%, #004d80 100%);
            color: white;
            padding: 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        header h1 {
            font-size: 28px;
            font-weight: 600;
            letter-spacing: 1px;
        }

        nav ul {
            list-style: none;
            display: flex;
            gap: 40px;
            align-items: center;
        }

        nav a {
            color: white;
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            transition: opacity 0.3s;
        }

        nav a:hover {
            opacity: 0.8;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-info span {
            font-size: 14px;
            opacity: 0.9;
        }

        .login-btn, .logout-btn {
            background-color: #ff6b35;
            color: white;
            padding: 8px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            border: none;
            transition: background-color 0.3s;
        }

        .login-btn:hover, .logout-btn:hover {
            background-color: #ff5722;
        }

        /* ä¸»å®¹å™¨ */
        main {
            max-width: 1400px;
            margin: 0 auto;
            padding: 60px 30px;
        }

        .hero {
            background: linear-gradient(135deg, #003366 0%, #0052a3 50%, #004d80 100%);
            color: white;
            padding: 80px 60px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 60px;
            box-shadow: 0 10px 30px rgba(0, 51, 102, 0.15);
        }

        .hero h2 {
            font-size: 42px;
            font-weight: 700;
            margin-bottom: 20px;
            line-height: 1.3;
        }

        .hero p {
            font-size: 18px;
            margin-bottom: 30px;
            opacity: 0.95;
        }

        .hero-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn-primary {
            background-color: #ff6b35;
            color: white;
            padding: 14px 40px;
            border-radius: 4px;
            text-decoration: none;
            font-weight: 600;
            border: none;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        .btn-primary:hover {
            background-color: #ff5722;
        }

        .btn-secondary {
            background-color: white;
            color: #003366;
            padding: 14px 40px;
            border-radius: 4px;
            text-decoration: none;
            font-weight: 600;
            border: 2px solid white;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }

        .btn-secondary:hover {
            background-color: #f0f0f0;
        }

        /* æœåŠ¡å¡ç‰‡ */
        .services {
            margin-bottom: 60px;
        }

        .section-title {
            font-size: 32px;
            font-weight: 700;
            text-align: center;
            margin-bottom: 50px;
            color: #003366;
        }

        .services-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin-bottom: 60px;
        }

        .service-card {
            background: white;
            padding: 40px 30px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s, box-shadow 0.3s;
            text-align: center;
        }

        .service-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .service-icon {
            font-size: 48px;
            margin-bottom: 20px;
        }

        .service-card h3 {
            font-size: 20px;
            margin-bottom: 15px;
            color: #003366;
            font-weight: 600;
        }

        .service-card p {
            color: #666;
            font-size: 14px;
            line-height: 1.8;
        }

        /* é¡µè„š */
        footer {
            background-color: #1a1a1a;
            color: white;
            text-align: center;
            padding: 40px 30px;
            margin-top: 60px;
            border-top: 1px solid #333;
        }

        /* è®¤è¯ç³»ç»Ÿ */
        .auth-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s;
        }

        .auth-modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .auth-content {
            background: white;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.3);
        }

        .auth-header {
            background: linear-gradient(135deg, #003366 0%, #0052a3 100%);
            color: white;
            padding: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 8px 8px 0 0;
        }

        .auth-header h2 {
            font-size: 22px;
            font-weight: 600;
            margin: 0;
        }

        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.3s;
        }

        .close-btn:hover {
            opacity: 0.8;
        }

        .auth-body {
            padding: 40px;
        }

        .progress-steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            position: relative;
        }

        .progress-steps::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            height: 2px;
            background: #ddd;
            z-index: 0;
        }

        .step {
            flex: 1;
            text-align: center;
            position: relative;
            z-index: 1;
        }

        .step-circle {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #f0f0f0;
            color: #999;
            font-weight: 600;
            margin-bottom: 8px;
            transition: all 0.3s;
        }

        .step.active .step-circle {
            background: #003366;
            color: white;
            box-shadow: 0 0 0 4px rgba(0, 51, 102, 0.1);
        }

        .step.completed .step-circle {
            background: #4CAF50;
            color: white;
        }

        .step-label {
            display: block;
            font-size: 12px;
            color: #999;
            font-weight: 500;
        }

        .step.active .step-label {
            color: #003366;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
            font-size: 14px;
        }

        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #003366;
            box-shadow: 0 0 0 2px rgba(0, 51, 102, 0.1);
        }

        .verification-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-size: 13px;
            color: #666;
        }

        .timer-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #ddd;
        }

        .qrcode-container {
            text-align: center;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .qrcode-container img {
            width: 200px;
            height: 200px;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 4px;
        }

        .backup-codes {
            background: #fff3cd;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            border-left: 3px solid #ffc107;
        }

        .backup-codes h4 {
            margin-bottom: 10px;
            color: #333;
            font-size: 13px;
        }

        .backup-codes code {
            display: inline-block;
            background: white;
            padding: 4px 8px;
            border-radius: 3px;
            margin: 3px;
            font-size: 12px;
            font-family: monospace;
        }

        .form-buttons {
            display: flex;
            gap: 10px;
            margin-top: 25px;
        }

        .form-buttons button {
            flex: 1;
            padding: 12px;
            border-radius: 4px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }

        .success-message {
            text-align: center;
            padding: 40px 20px;
        }

        .success-icon {
            font-size: 48px;
            color: #4CAF50;
            margin-bottom: 20px;
        }

        .success-message h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 20px;
        }

        .success-message p {
            color: #666;
            font-size: 14px;
            margin-bottom: 25px;
        }

        .alert {
            padding: 12px 15px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 13px;
        }

        .alert-error {
            background: #fee;
            color: #c33;
            border: 1px solid #fcc;
        }

        .alert-success {
            background: #efe;
            color: #3c3;
            border: 1px solid #cfc;
        }

        .alert-info {
            background: #eef;
            color: #33c;
            border: 1px solid #ccf;
        }

        .hidden {
            display: none;
        }

        @media (max-width: 600px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
            }

            nav ul {
                gap: 15px;
                flex-wrap: wrap;
                justify-content: center;
            }

            .hero {
                padding: 40px 20px;
            }

            .hero h2 {
                font-size: 28px;
            }

            .hero-buttons {
                flex-direction: column;
            }

            .auth-content {
                max-width: 95%;
            }
        }
    </style>
</head>

<body>
    <!-- å¯¼èˆªå¤´ -->
    <header>
        <div class="header-content">
            <h1>å…‰è”ä¸–çºª</h1>
            <nav>
                <ul>
                    <li><a href="#home">é¦–é¡µ</a></li>
                    <li><a href="#services">æœåŠ¡</a></li>
                    <li><a href="#about">å…³äº</a></li>
                    <li class="user-info" id="userInfo" style="display: none;">
                        <span id="username"></span>
                        <button class="logout-btn" onclick="logout()">é€€å‡º</button>
                    </li>
                    <li id="authButton">
                        <button class="login-btn" onclick="openLoginModal()">ç™»å½•</button>
                    </li>
                </ul>
            </nav>
        </div>
    </header>

    <!-- ä¸»å†…å®¹ -->
    <main>
        <section class="hero" id="home">
            <h2>è®©æ™ºèƒ½ç½‘ç»œæœåŠ¡ä¸ºå®¢æˆ·åˆ›é€ ä»·å€¼</h2>
            <p>ä¸“æ³¨äºä¼ä¸šæ™ºèƒ½ç½‘ç»œæœåŠ¡é¢†åŸŸï¼Œæä¾›å®šåˆ¶åŒ–è§£å†³æ–¹æ¡ˆ</p>
            <div class="hero-buttons">
                <button class="btn-primary" onclick="openLoginModal()">ç«‹å³ç™»å½•</button>
                <button class="btn-secondary" onclick="openRegisterModal()">æ³¨å†Œè´¦æˆ·</button>
            </div>
        </section>

        <section class="services" id="services">
            <h2 class="section-title">æ ¸å¿ƒæœåŠ¡</h2>
            <div class="services-grid">
                <div class="service-card">
                    <div class="service-icon">ğŸŒ</div>
                    <h3>SD-WAN</h3>
                    <p>è½¯ä»¶å®šä¹‰å¹¿åŸŸç½‘ï¼Œæä¾›çµæ´»ã€é«˜æ•ˆçš„ä¼ä¸šç½‘ç»œè¿æ¥</p>
                </div>
                <div class="service-card">
                    <div class="service-icon">ğŸ”’</div>
                    <h3>SASE</h3>
                    <p>å®‰å…¨è®¿é—®æœåŠ¡è¾¹ç¼˜ï¼Œæ•´åˆç½‘ç»œå’Œå®‰å…¨åŠŸèƒ½</p>
                </div>
                <div class="service-card">
                    <div class="service-icon">â˜ï¸</div>
                    <h3>äº‘ç½‘èåˆ</h3>
                    <p>äº‘è®¡ç®—ä¸ç½‘ç»œæ·±åº¦èåˆï¼Œæä¾›é«˜æ•ˆçš„ç½‘ç»œä½“éªŒ</p>
                </div>
            </div>
        </section>
    </main>

    <footer>
        <p>Copyright Â© 2005-2026 Fnetlink.com All Rights Reserved.</p>
        <p>å…‰è”ä¸–çºª | ä¼ä¸šæ™ºèƒ½ç½‘ç»œæœåŠ¡æä¾›å•†</p>
    </footer>

    <!-- ç™»å½•æ¨¡æ€çª—å£ -->
    <div id="loginModal" class="auth-modal">
        <div class="auth-content">
            <div class="auth-header">
                <h2 id="authTitle">ç”¨æˆ·ç™»å½•</h2>
                <button class="close-btn" onclick="closeAuthModal()">&times;</button>
            </div>
            <div class="auth-body">
                <!-- è¿›åº¦æŒ‡ç¤ºå™¨ -->
                <div class="progress-steps" id="progressSteps">
                    <div class="step active" id="step1-indicator">
                        <span class="step-circle">1</span>
                        <span class="step-label">å¯†ç </span>
                    </div>
                    <div class="step" id="step2-indicator">
                        <span class="step-circle">2</span>
                        <span class="step-label">é‚®ä»¶éªŒè¯</span>
                    </div>
                    <div class="step" id="step3-indicator">
                        <span class="step-circle">3</span>
                        <span class="step-label">2FAéªŒè¯</span>
                    </div>
                </div>

                <!-- é”™è¯¯/æç¤ºä¿¡æ¯ -->
                <div id="alertContainer"></div>

                <!-- ç¬¬ä¸€æ­¥ï¼šç”¨æˆ·åå’Œå¯†ç  -->
                <div id="step1" class="auth-step">
                    <div class="form-group">
                        <label for="username">ç”¨æˆ·åæˆ–é‚®ç®±</label>
                        <input type="text" id="username" placeholder="è¯·è¾“å…¥ç”¨æˆ·åæˆ–é‚®ç®±">
                    </div>
                    <div class="form-group">
                        <label for="password">å¯†ç </label>
                        <input type="password" id="password" placeholder="è¯·è¾“å…¥å¯†ç ">
                    </div>
                    <button class="btn-primary" style="width: 100%;" onclick="step1Verify()">ä¸‹ä¸€æ­¥</button>
                </div>

                <!-- ç¬¬äºŒæ­¥ï¼šé‚®ä»¶éªŒè¯ -->
                <div id="step2" class="auth-step hidden">
                    <div class="verification-info">
                        éªŒè¯ç å·²å‘é€è‡³æ‚¨çš„é‚®ç®±<br>
                        <strong id="emailDisplay"></strong>
                    </div>
                    <div class="form-group">
                        <label for="emailCode">è¯·è¾“å…¥6ä½éªŒè¯ç </label>
                        <input type="text" id="emailCode" placeholder="000000" maxlength="6" pattern="[0-9]{6}">
                    </div>
                    <div class="timer-info">
                        <span id="resendTimer">60ç§’åå¯é‡æ–°å‘é€</span>
                        <button class="btn-secondary" id="resendBtn" disabled style="border: none; background: none; padding: 0; color: #ccc; cursor: not-allowed;" onclick="resendCode()">é‡æ–°å‘é€</button>
                    </div>
                    <div class="form-buttons">
                        <button class="btn-secondary" onclick="goBackStep(1)">è¿”å›</button>
                        <button class="btn-primary" onclick="step2Verify()">ä¸‹ä¸€æ­¥</button>
                    </div>
                </div>

                <!-- ç¬¬ä¸‰æ­¥ï¼šåŒå› ç´ è®¤è¯ -->
                <div id="step3" class="auth-step hidden">
                    <div class="verification-info">
                        è¯·è¾“å…¥æ‚¨çš„èº«ä»½éªŒè¯å™¨ä¸­çš„6ä½æ•°å­—
                    </div>
                    <div class="form-group">
                        <label for="totpCode">éªŒè¯ç </label>
                        <input type="text" id="totpCode" placeholder="000000" maxlength="6" pattern="[0-9]{6}">
                    </div>
                    <div class="verification-info">
                        æˆ–è¾“å…¥æ‚¨çš„å¤‡ç”¨ç 
                    </div>
                    <div class="form-group">
                        <label for="backupCode">å¤‡ç”¨ç </label>
                        <input type="text" id="backupCode" placeholder="è¯·è¾“å…¥å¤‡ç”¨ç " style="text-transform: uppercase;">
                    </div>
                    <div class="form-buttons">
                        <button class="btn-secondary" onclick="goBackStep(2)">è¿”å›</button>
                        <button class="btn-primary" onclick="step3Verify()">ç™»å½•</button>
                    </div>
                </div>

                <!-- æˆåŠŸç•Œé¢ -->
                <div id="successStep" class="auth-step hidden">
                    <div class="success-message">
                        <div class="success-icon">âœ“</div>
                        <h3>ç™»å½•æˆåŠŸ</h3>
                        <p id="successMessage"></p>
                        <button class="btn-primary" style="width: 100%;" onclick="completeLogin()">è¿›å…¥ç³»ç»Ÿ</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:5000/api';
        let currentStep = 1;
        let isRegisterMode = false;  // æ·»åŠ æ ‡å¿—å˜é‡
        let authData = {
            username: '',
            sessionToken: '',
            email: ''
        };

        function showAlert(message, type = 'error') {
            const alertContainer = document.getElementById('alertContainer');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            alertContainer.innerHTML = '';
            alertContainer.appendChild(alertDiv);
        }

        function clearAlert() {
            document.getElementById('alertContainer').innerHTML = '';
        }

        function openLoginModal() {
            document.getElementById('loginModal').classList.add('show');
            document.body.style.overflow = 'hidden';
            isRegisterMode = false;
            
            // æ¢å¤ step1 ä¸ºåŸå§‹ç™»å½•è¡¨å•
            document.getElementById('step1').innerHTML = `
                    <div class="form-group">
                        <label for="username">ç”¨æˆ·åæˆ–é‚®ç®±</label>
                        <input type="text" id="username" placeholder="è¯·è¾“å…¥ç”¨æˆ·åæˆ–é‚®ç®±">
                    </div>
                    <div class="form-group">
                        <label for="password">å¯†ç </label>
                        <input type="password" id="password" placeholder="è¯·è¾“å…¥å¯†ç ">
                    </div>
                    <button class="btn-primary" style="width: 100%;" onclick="step1Verify()">ä¸‹ä¸€æ­¥</button>
                `;
            
            resetAuth();
        }

        function openRegisterModal() {
            document.getElementById('loginModal').classList.add('show');
            document.body.style.overflow = 'hidden';
            isRegisterMode = true;
            
            // æ˜¾ç¤ºæ³¨å†Œè¡¨å•
            document.getElementById('step1').innerHTML = `
                    <div class="form-group">
                        <label>ç”¨æˆ·å</label>
                        <input type="text" id="regUsername" placeholder="è¾“å…¥ç”¨æˆ·å">
                    </div>
                    <div class="form-group">
                        <label>é‚®ç®±</label>
                        <input type="email" id="regEmail" placeholder="è¾“å…¥é‚®ç®±åœ°å€">
                    </div>
                    <div class="form-group">
                        <label>å¯†ç </label>
                        <input type="password" id="regPassword" placeholder="è¾“å…¥å¯†ç ">
                    </div>
                    <div class="form-group">
                        <label>ç¡®è®¤å¯†ç </label>
                        <input type="password" id="regPasswordConfirm" placeholder="å†æ¬¡è¾“å…¥å¯†ç ">
                    </div>
                    <div class="form-buttons">
                        <button onclick="registerUser()" style="background: #003366; color: white; flex: 1;">æ³¨å†Œ</button>
                        <button onclick="closeAuthModal()" style="background: #ccc; flex: 1;">å…³é—­</button>
                    </div>
                `;
            
            // éšè—æ­¥éª¤æŒ‡ç¤ºå™¨
            document.querySelectorAll('.step').forEach(s => s.classList.add('hidden'));
            
            resetAuth();
        }

        function closeAuthModal() {
            document.getElementById('loginModal').classList.remove('show');
            document.body.style.overflow = 'auto';
        }

        function resetAuth() {
            currentStep = 1;
            authData = { username: '', sessionToken: '', email: '' };
            
            // æ¸…ç©ºç™»å½•è¡¨å•
            const username = document.getElementById('username');
            const password = document.getElementById('password');
            if (username) username.value = '';
            if (password) password.value = '';
            
            // æ¸…ç©ºé‚®ä»¶éªŒè¯è¡¨å•
            const emailCode = document.getElementById('emailCode');
            if (emailCode) emailCode.value = '';
            
            // æ¸…ç©º TOTP è¡¨å•
            const totpCode = document.getElementById('totpCode');
            const backupCode = document.getElementById('backupCode');
            if (totpCode) totpCode.value = '';
            if (backupCode) backupCode.value = '';
            
            clearAlert();
            
            if (!isRegisterMode) {
                // ç™»å½•æ¨¡å¼ï¼šæ˜¾ç¤ºæ­¥éª¤æŒ‡ç¤ºå™¨
                document.querySelectorAll('.step').forEach(s => s.classList.remove('hidden'));
                document.getElementById('step2').classList.add('hidden');
                document.getElementById('step3').classList.add('hidden');
                document.getElementById('successStep').classList.add('hidden');
                document.getElementById('step1').classList.remove('hidden');
                updateStepDisplay();
            }
        }

        function updateStepDisplay() {
            // éšè—æ‰€æœ‰æ­¥éª¤
            document.querySelectorAll('.auth-step').forEach(step => {
                step.classList.add('hidden');
            });

            // æ›´æ–°è¿›åº¦æŒ‡ç¤ºå™¨
            document.querySelectorAll('.step').forEach((step, idx) => {
                step.classList.remove('active', 'completed');
                if (idx + 1 === currentStep) {
                    step.classList.add('active');
                } else if (idx + 1 < currentStep) {
                    step.classList.add('completed');
                }
            });

            // æ˜¾ç¤ºå½“å‰æ­¥éª¤
            const stepMap = {
                1: 'step1',
                2: 'step2',
                3: 'step3',
                4: 'successStep'
            };

            const stepId = stepMap[currentStep];
            if (stepId) {
                document.getElementById(stepId).classList.remove('hidden');
                
                // å¦‚æœæ˜¯ç¬¬ä¸‰æ­¥ï¼Œå…ˆè°ƒç”¨setupTOTPæ¥è·å–äºŒç»´ç æˆ–ç›´æ¥éªŒè¯
                if (currentStep === 3) {
                    setupTOTP();
                }
            }

            const titles = {
                1: 'ç”¨æˆ·ç™»å½• - ç¬¬1æ­¥',
                2: 'ç”¨æˆ·ç™»å½• - ç¬¬2æ­¥',
                3: 'ç”¨æˆ·ç™»å½• - ç¬¬3æ­¥',
                4: 'ç™»å½•æˆåŠŸ'
            };
            document.getElementById('authTitle').textContent = titles[currentStep];
        }

        function goBackStep(step) {
            currentStep = step;
            clearAlert();
            updateStepDisplay();
        }

        async function step1Verify() {
            // ä» step1 å®¹å™¨å†…æŸ¥æ‰¾è¾“å…¥æ¡†ï¼Œç¡®ä¿è·å–çš„æ˜¯æ­£ç¡®çš„å…ƒç´ 
            const step1Container = document.getElementById('step1');
            const inputs = step1Container.querySelectorAll('input');
            
            let username = '';
            let password = '';
            
            // æŸ¥æ‰¾ username å’Œ password è¾“å…¥æ¡†
            inputs.forEach(input => {
                if (input.placeholder && input.placeholder.includes('ç”¨æˆ·å')) {
                    username = input.value;
                } else if (input.type === 'password') {
                    password = input.value;
                }
            });

            if (!username || !password) {
                showAlert('è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/auth/step1`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();

                if (!response.ok) {
                    showAlert(data.error || 'éªŒè¯å¤±è´¥');
                    return;
                }

                authData.username = username;
                authData.sessionToken = data.sessionToken;
                authData.email = data.email;

                // å‘é€éªŒè¯ç 
                sendEmailCode();
            } catch (error) {
                showAlert('ç½‘ç»œé”™è¯¯ï¼š' + error.message);
            }
        }

        async function sendEmailCode() {
            try {
                const response = await fetch(`${API_BASE}/auth/step2/send-code`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sessionToken: authData.sessionToken })
                });

                const data = await response.json();

                if (!response.ok) {
                    showAlert(data.error || 'å‘é€éªŒè¯ç å¤±è´¥');
                    return;
                }

                document.getElementById('emailDisplay').textContent = data.emailTip;
                currentStep = 2;
                clearAlert();
                showAlert('éªŒè¯ç å·²å‘é€ï¼Œè¯·æŸ¥æ”¶é‚®ä»¶', 'success');
                updateStepDisplay();
                startResendTimer();
            } catch (error) {
                showAlert('ç½‘ç»œé”™è¯¯ï¼š' + error.message);
            }
        }

        function startResendTimer() {
            let countdown = 60;
            const timerEl = document.getElementById('resendTimer');
            const resendBtn = document.getElementById('resendBtn');

            resendBtn.disabled = true;

            const interval = setInterval(() => {
                countdown--;
                timerEl.textContent = countdown + 'ç§’åå¯é‡æ–°å‘é€';

                if (countdown === 0) {
                    clearInterval(interval);
                    resendBtn.disabled = false;
                    resendBtn.style.color = '#003366';
                    resendBtn.style.cursor = 'pointer';
                }
            }, 1000);
        }

        function resendCode() {
            sendEmailCode();
        }

        async function step2Verify() {
            const code = document.getElementById('emailCode').value;

            if (!code || code.length !== 6) {
                showAlert('è¯·è¾“å…¥6ä½éªŒè¯ç ');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/auth/step2/verify-code`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        sessionToken: authData.sessionToken,
                        code: code
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    showAlert(data.error || 'éªŒè¯å¤±è´¥');
                    return;
                }

                currentStep = 3;
                clearAlert();
                updateStepDisplay();
            } catch (error) {
                showAlert('ç½‘ç»œé”™è¯¯ï¼š' + error.message);
            }
        }

        async function step3Verify() {
            const totpCode = document.getElementById('totpCode').value;
            const backupCode = document.getElementById('backupCode').value;

            if (!totpCode && !backupCode) {
                showAlert('è¯·è¾“å…¥éªŒè¯ç æˆ–å¤‡ç”¨ç ');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/auth/step3/verify-totp`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        sessionToken: authData.sessionToken,
                        totpCode: totpCode || null,
                        backupCode: backupCode || null
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    showAlert(data.error || 'éªŒè¯å¤±è´¥');
                    return;
                }

                // ä¿å­˜token
                localStorage.setItem('authToken', data.token);
                document.getElementById('successMessage').textContent = `æ¬¢è¿å›æ¥ï¼Œ${data.user.username}`;

                currentStep = 4;
                clearAlert();
                updateStepDisplay();
            } catch (error) {
                showAlert('ç½‘ç»œé”™è¯¯ï¼š' + error.message);
            }
        }

        // æ–°å¢ï¼šè®¾ç½®TOTPï¼ˆç¬¬ä¸€æ¬¡ä½¿ç”¨æ—¶ï¼‰
        async function setupTOTP() {
            try {
                const response = await fetch(`${API_BASE}/auth/step3/setup-totp`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sessionToken: authData.sessionToken })
                });

                const data = await response.json();

                if (!response.ok) {
                    showAlert(data.error || 'TOTPè®¾ç½®å¤±è´¥');
                    return;
                }

                // æ˜¾ç¤ºTOTPè®¾ç½®ç•Œé¢
                if (data.totpEnabled) {
                    // ç”¨æˆ·å·²å¯ç”¨TOTPï¼Œç›´æ¥æ˜¾ç¤ºéªŒè¯ç•Œé¢
                    updateStepDisplay();
                } else {
                    // ä¿å­˜ secret ä¾›åç»­ä½¿ç”¨
                    authData.totpSecret = data.secret;
                    
                    // æ˜¾ç¤ºäºŒç»´ç è®¾ç½®ç•Œé¢
                    const step3Container = document.getElementById('step3');
                    step3Container.innerHTML = `
                        <div class="verification-info">
                            è¯·ä½¿ç”¨èº«ä»½éªŒè¯å™¨åº”ç”¨æ‰«æäºŒç»´ç 
                        </div>
                        <div class="qrcode-container">
                            <img src="data:image/png;base64,${data.qrCode}" alt="TOTPäºŒç»´ç ">
                        </div>
                        <div class="backup-codes">
                            <h4>âš ï¸ å¤‡ç”¨ç ï¼ˆè¯·å¦¥å–„ä¿å­˜ï¼‰</h4>
                            <div>
                                ${data.backupCodes.map(code => `<code>${code}</code>`).join('')}
                            </div>
                        </div>
                        <div class="verification-info">
                            è¯·åœ¨éªŒè¯å™¨ä¸­è¾“å…¥6ä½éªŒè¯ç ä»¥å®Œæˆè®¾ç½®
                        </div>
                        <div class="form-group">
                            <label for="totpCode">éªŒè¯ç </label>
                            <input type="text" id="totpCode" placeholder="000000" maxlength="6" pattern="[0-9]{6}">
                        </div>
                        <div class="form-buttons">
                            <button class="btn-secondary" onclick="goBackStep(2)">è¿”å›</button>
                            <button class="btn-primary" onclick="confirmTOTPSetup()">ä¸‹ä¸€æ­¥</button>
                        </div>
                    `;
                }
            } catch (error) {
                showAlert('ç½‘ç»œé”™è¯¯ï¼š' + error.message);
            }
        }

        // æ–°å¢ï¼šç¡®è®¤TOTPè®¾ç½®
        async function confirmTOTPSetup() {
            const totpCode = document.getElementById('totpCode').value;

            if (!totpCode || totpCode.length !== 6) {
                showAlert('è¯·è¾“å…¥6ä½éªŒè¯ç ');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/auth/step3/verify-totp`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        sessionToken: authData.sessionToken,
                        totpCode: totpCode,
                        secret: authData.totpSecret  // å‘é€ secret ç”¨äºé¦–æ¬¡å¯ç”¨
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    showAlert(data.error || 'éªŒè¯å¤±è´¥');
                    return;
                }

                // ä¿å­˜token
                localStorage.setItem('authToken', data.token);
                document.getElementById('successMessage').textContent = `æ¬¢è¿å›æ¥ï¼Œ${data.user.username}`;

                currentStep = 4;
                clearAlert();
                updateStepDisplay();
            } catch (error) {
                showAlert('ç½‘ç»œé”™è¯¯ï¼š' + error.message);
            }
        }

        function completeLogin() {
            closeAuthModal();
            updateUserInfo();
            location.reload();
        }

        async function registerUser() {
            // ä» step1 å®¹å™¨å†…æŸ¥æ‰¾è¾“å…¥æ¡†ï¼Œç¡®ä¿è·å–çš„æ˜¯æ­£ç¡®çš„å…ƒç´ 
            const step1Container = document.getElementById('step1');
            const inputs = step1Container.querySelectorAll('input');
            
            let username = '';
            let email = '';
            let password = '';
            let passwordConfirm = '';
            
            // æŸ¥æ‰¾å„ä¸ªè¾“å…¥æ¡†
            inputs.forEach(input => {
                if (input.placeholder && input.placeholder.includes('ç”¨æˆ·å')) {
                    username = input.value;
                } else if (input.type === 'email') {
                    email = input.value;
                } else if (input.placeholder && input.placeholder.includes('å†æ¬¡è¾“å…¥')) {
                    passwordConfirm = input.value;
                } else if (input.type === 'password' && !passwordConfirm) {
                    password = input.value;
                }
            });

            if (!username || !email || !password || !passwordConfirm) {
                showAlert('è¯·å¡«å†™æ‰€æœ‰å­—æ®µ');
                return;
            }

            if (password !== passwordConfirm) {
                showAlert('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´');
                return;
            }

            if (password.length < 6) {
                showAlert('å¯†ç é•¿åº¦è‡³å°‘6ä½');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, email, password })
                });

                const data = await response.json();

                if (!response.ok) {
                    showAlert(data.error || 'æ³¨å†Œå¤±è´¥');
                    return;
                }

                showAlert('æ³¨å†ŒæˆåŠŸï¼è¯·ç”¨æ–°è´¦æˆ·ç™»å½•', 'success');
                setTimeout(() => {
                    // åˆ‡æ¢åˆ°ç™»å½•æ¨¡å¼å¹¶é‡æ–°æ˜¾ç¤ºç™»å½•è¡¨å•
                    isRegisterMode = false;
                    document.getElementById('step1').innerHTML = `
                        <div class="form-group">
                            <label for="username">ç”¨æˆ·åæˆ–é‚®ç®±</label>
                            <input type="text" id="username" placeholder="è¯·è¾“å…¥ç”¨æˆ·åæˆ–é‚®ç®±">
                        </div>
                        <div class="form-group">
                            <label for="password">å¯†ç </label>
                            <input type="password" id="password" placeholder="è¯·è¾“å…¥å¯†ç ">
                        </div>
                        <button class="btn-primary" style="width: 100%;" onclick="step1Verify()">ä¸‹ä¸€æ­¥</button>
                    `;
                    resetAuth();
                }, 1500);
            } catch (error) {
                showAlert('ç½‘ç»œé”™è¯¯ï¼š' + error.message);
            }
        }

        function updateUserInfo() {
            const token = localStorage.getItem('authToken');
            if (token) {
                const decoded = JSON.parse(atob(token.split('.')[1]));
                document.getElementById('username').textContent = decoded.username;
                document.getElementById('userInfo').style.display = 'flex';
                document.getElementById('authButton').style.display = 'none';
            }
        }

        function logout() {
            localStorage.removeItem('authToken');
            document.getElementById('userInfo').style.display = 'none';
            document.getElementById('authButton').style.display = 'block';
            location.reload();
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
        window.addEventListener('load', () => {
            updateUserInfo();
        });

        // ESCå…³é—­çª—å£
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeAuthModal();
        });

        // ç‚¹å‡»èƒŒæ™¯å…³é—­
        document.getElementById('loginModal').addEventListener('click', (e) => {
            if (e.target.id === 'loginModal') closeAuthModal();
        });
    </script>
</body>

</html>
